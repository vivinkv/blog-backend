<%- include('../wrapper/header') %>

<aside
  class="bg-gray-200 w-40 max-md:w-20 h-screen p-5 fixed inset-y-0 left-0 transform -translate-x-full transition-transform duration-300 md:translate-x-0 z-20"
  id="sidebar"
>
  <div class="flex justify-center mb-5">
    <img src="/logo.png" class="h-10 w-10 md:h-24 md:w-24" alt="blogs" />
  </div>
  <nav>
    <ul class="space-y-4">
      <li>
        <a
          href="/admin/dashboard"
          class="mb-4 flex gap-x-2 items-center text-blue-900 hover:text-blue-500"
        >
          <img src="/users.svg" class="h-7 w-7" alt="users" />
          <span class="font-semibold text-md text-gray-500 hidden md:block"
            >Users</span
          >
        </a>
      </li>
      <li>
        <a
          href="/admin/dashboard/blogs"
          class="gap-x-2 flex items-center text-blue-900 hover:text-blue-500"
        >
          <img src="/blogs.svg" class="h-7 w-7" alt="blogs" />
          <span class="font-semibold text-md text-gray-500 hidden md:block"
            >Blogs</span
          >
        </a>
      </li>
      <li>
        <a
          href="/admin/dashboard/forums"
          class="gap-x-2 flex items-center text-blue-900 hover:text-blue-500 w-32 max-md:w-10 px-3 py-2 rounded-lg"
        >
          <img src="/forum.svg" class="h-7 w-7" alt="blogs" />
          <span class="font-semibold text-md text-gray-500 hidden md:block"
            >Forums</span
          >
        </a>
      </li>
      <li>
        <a
          href="/admin/career"
          class="gap-x-2 flex items-center text-blue-900 hover:text-blue-500 w-32 max-md:w-10 px-3 py-2 rounded-lg"
        >
          <img src="/career.svg" class="h-7 w-7" alt="blogs" />
          <span class="font-semibold text-md text-gray-500 hidden md:block"
            >Career</span
          >
        </a>
      </li>
      <li>
        <a
          href="/admin/services"
          class="gap-x-2 flex items-center text-blue-900 hover:text-blue-500 w-32 max-md:w-10 px-3 py-2 rounded-lg"
        >
          <img src="/career.svg" class="h-7 w-7" alt="blogs" />
          <span class="font-semibold text-md text-gray-500 hidden md:block"
            >Services</span
          >
        </a>
      </li>
      <li>
        <a
          href="/admin/menu"
          class="gap-x-2 flex items-center text-blue-900 hover:text-blue-500 bg-gray-300 w-32 px-3 py-2 rounded-lg"
        >
          <img src="/menu.svg" class="h-7 w-7" alt="blogs" />
          <span class="font-semibold text-md text-gray-500 hidden md:block"
            >Menu</span
          >
        </a>
      </li>
    </ul>
  </nav>
</aside>
>

<h1 class="ms-[14rem] my-3 text-3xl font-bold"><%= title %></h1>

<!-- New Icon to Create Route at Root Level -->
<div class="flex justify-end mb-4">
  <button
    id="create-root-route-button"
    onclick="openFormModal('create', 'null')"
    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
  >
    ➕ Create Root Route
  </button>
</div>

<!-- form -->

<!-- Route Form Modal -->
<!-- <div class="modal route-form-modal fixed inset-0 z-10 bg-black bg-opacity-50 flex justify-center items-center hidden">
  <div class="bg-white p-6 rounded-lg shadow-lg w-96">
    <h2 class="text-xl font-semibold mb-4">Create New Route</h2>
    
    <form id="route-form" class="grid grid-cols-2 gap-4" enctype="multipart/form-data">
      <div class="col-span-2">
        <p class="text-gray-600 mb-2">Enter Title</p>
        <input type="text" id="title" required minlength="3" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Route Title" />
        <p class="text-red-600 mt-1" id="titleError"></p>
      </div>

      <div>
        <p class="text-gray-600 mb-2">Select Priority</p>
        <select id="priority" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
          <option selected value="1">High</option>
          <option value="2">Medium</option>
          <option value="3">Low</option>
        </select>
      </div>

      <div>
        <p class="text-gray-600 mb-2">Enter Link</p>
        <input type="text" id="route-link" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Route Link" />
      </div>

      <div class="col-span-2">
        <p class="text-gray-600 mb-2">Enter Tooltip</p>
        <input type="text" id="tooltip" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tooltip Text" />
      </div>

      <div class="col-span-2">
        <p class="text-gray-600 mb-2">Upload Icon</p>
        <input type="file" id="file" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" accept="image/*" />
      </div>
    </form>

    <div class="flex justify-end gap-4 mt-6">
      <button id="save-route" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
      <button class="close-form-modal bg-gray-300 px-4 py-2 rounded">Cancel</button>
    </div>
  </div>
</div> -->

<!-- Route Form Modal -->
<div
  class="modal route-form-modal fixed inset-0 z-10 bg-black bg-opacity-50 flex justify-center items-center hidden"
>
  <div class="bg-white p-6 rounded-lg shadow-lg w-96">
    <h2 id="modal-title" class="text-xl font-semibold mb-4">
      Create New Route
    </h2>

    <form
      id="route-form"
      class="grid grid-cols-2 gap-4"
      enctype="multipart/form-data"
    >
      <div class="col-span-2">
        <p class="text-gray-600 mb-2">Enter Title</p>
        <input
          type="text"
          id="title"
          required
          minlength="3"
          class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Route Title"
        />
        <p class="text-red-600 mt-1" id="titleError"></p>
      </div>

      <div>
        <p class="text-gray-600 mb-2">Select Priority</p>
        <select
          id="priority"
          class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
        >
          <option selected value="1">High</option>
          <option value="2">Medium</option>
          <option value="3">Low</option>
        </select>
      </div>

      <div>
        <p class="text-gray-600 mb-2">Enter Link</p>
        <input
          type="text"
          id="route-link"
          class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Route Link"
        />
      </div>

      <div class="col-span-2">
        <p class="text-gray-600 mb-2">Enter Tooltip</p>
        <input
          type="text"
          id="tooltip"
          class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Tooltip Text"
        />
      </div>

      <div class="col-span-2">
        <p class="text-gray-600 mb-2">Upload Icon</p>
        <input
          type="file"
          id="file"
          class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
          accept="image/*"
        />
      </div>
    </form>

    <div class="flex justify-end gap-4 mt-6">
      <button
        id="save-route"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
      >
        Save
      </button>
      <button class="close-form-modal bg-gray-300 px-4 py-2 rounded">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Route edit Form Modal -->
<div
  class="modal route-form-modal-edit fixed inset-0 z-10 bg-black bg-opacity-50 flex justify-center items-center hidden"
>
  <div class="bg-white p-6 rounded-lg shadow-lg w-96">
    <h2 id="modal-title" class="text-xl font-semibold mb-4">Edit Route</h2>

    <form
      id="route-form-edit"
      class="grid grid-cols-2 gap-4"
      enctype="multipart/form-data"
    >
      <div class="col-span-2">
        <p class="text-gray-600 mb-2">Enter Title</p>
        <input
          type="text"
          id="edit-title"
          required
          minlength="3"
          class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Route Title"
        />
        <p class="text-red-600 mt-1" id="edit-titleError"></p>
      </div>

      <div>
        <p class="text-gray-600 mb-2">Select Priority</p>
        <input type="hidden" name="" id="edit-id" />
        <select
          id="edit-priority"
          class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
        >
          <option selected value="1">High</option>
          <option value="2">Medium</option>
          <option value="3">Low</option>
        </select>
      </div>

      <div>
        <p class="text-gray-600 mb-2">Enter Link</p>
        <input
          type="text"
          id="edit-route-link"
          class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Route Link"
        />
      </div>

      <div class="col-span-2">
        <p class="text-gray-600 mb-2">Enter Tooltip</p>
        <input
          type="text"
          id="edit-tooltip"
          class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Tooltip Text"
        />
      </div>

      <div class="col-span-2">
        <p class="text-gray-600 mb-2">Upload Icon</p>
        <input
          type="file"
          id="edit-file"
          class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
          accept="image/*"
        />
      </div>
    </form>

    <div class="flex justify-end gap-4 mt-6">
      <button
        id="update-route"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
      >
        Update
      </button>
      <button class="close-form-modal-edit bg-gray-300 px-4 py-2 rounded">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div
  class="modal delete-modal fixed z-10 inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden"
>
  <div class="bg-white rounded-lg p-6 w-96">
    <h2 class="text-lg font-semibold mb-4">Delete Route</h2>
    <p>Are you sure you want to delete this route?</p>
    <div class="flex justify-end mt-4">
      <button
        class="confirm-delete bg-red-500 text-white px-4 py-2 rounded mr-2"
      >
        Delete
      </button>
      <button class="close-delete-modal bg-gray-300 px-4 py-2 rounded">
        Cancel
      </button>
    </div>
  </div>
</div>

<div class="min-h-screen p-6 bg-gray-100 ms-[14rem]">
  <div class="bg-white shadow-md rounded-lg p-4">
    <ul id="tree-view" class="list-none p-0 m-0">
      <!-- Tree View Items will be dynamically generated here -->
    </ul>
    <!-- Default Form to Create New Node if No Nodes Exist -->
    <div id="default-form" class="mt-6">
      <ul class="list-none">
        <% data.forEach(item => { %>
        <li
          class="tree-node py-2 px-4 cursor-pointer relative rounded-md hover:bg-gray-200"
        >
          <div class="flex items-center relative">
            <div
              class="collapse-icon w-4 h-4 me-5 border border-gray-400 rounded-full flex items-center justify-center cursor-pointer"
            >
              ▶
            </div>
            <img src="<%= item.icon %>" class="h-7 w-7 me-2" alt="item.title" />
            <span><%= item.title %></span>
            <div class="ml-auto flex items-center space-x-2">
              <button
                class="add-icon text-green-500 ml-2"
                id="create-child-route-button"
                onclick="openFormModal('create', '<%= item.id %>')"
              >
                ➕
              </button>
              <button
                class="edit-icon text-blue-500 ml-2"
                data-id="<%= item.id %>"
                data-title="<%= item.title %>"
                data-link="<%= item.link %>"
                data-tooltip="<%= item.tooltip %>"
                onclick="openFormModal('edit', '<%= item.id %>')"
              >
                ✏️
              </button>
              <button
                class="delete-icon text-red-500 ml-2"
                onclick="openDeleteModal('<%= item.id %>')"
              >
                🗑️
              </button>
            </div>
          </div>
          <% if (item.submenu && item.submenu.length > 0) { %>
          <ul class="pl-4 border-l border-gray-300 hidden">
            <% item.submenu.forEach(child => { %>
            <li
              class="tree-node py-2 px-4 cursor-pointer relative rounded-md hover:bg-gray-200"
            >
              <div class="flex items-center relative">
                <div
                  class="collapse-icon w-4 h-4 me-5 border border-gray-400 rounded-full flex items-center justify-center cursor-pointer"
                >
                  ▶
                </div>
                <img
                  src="<%= child.icon %>"
                  class="h-7 w-7 me-2"
                  alt="item.title"
                />
                <span><%= child.title %></span>
                <div class="ml-auto flex items-center space-x-2">
                  <button
                    class="add-icon text-green-500 ml-2"
                    onclick="openFormModal('create', '<%= child.id %>')"
                  >
                    ➕
                  </button>
                  <button
                    class="edit-icon text-blue-500 ml-2"
                    onclick="openFormModal('edit', '<%= child.id %>')"
                  >
                    ✏️
                  </button>
                  <button
                    class="delete-icon text-red-500 ml-2"
                    onclick="openDeleteModal('<%= child.id %>')"
                  >
                    🗑️
                  </button>
                </div>
              </div>
              <% if (child.submenu && child.submenu.length > 0) { %>
              <ul class="pl-4 border-l border-gray-300 hidden">
                <% child.submenu.forEach(grandchild => { %>
                <li
                  class="tree-node py-2 px-4 cursor-pointer relative rounded-md hover:bg-gray-200"
                >
                  <div class="flex items-center relative">
                    <div
                      class="collapse-icon w-4 h-4 me-5 border border-gray-400 rounded-full flex items-center justify-center cursor-pointer"
                    >
                      ▶
                    </div>
                    <img
                      src="<%= grandchild.icon %>"
                      class="h-7 w-7 me-2"
                      alt="<%= grandchild.title %>"
                    />
                    <span><%= grandchild.title %></span>
                    <div class="ml-auto flex items-center space-x-2">
                      <button
                        class="add-icon text-green-500 ml-2"
                        onclick="openFormModal('create', '<%= grandchild.id %>')"
                      >
                        ➕
                      </button>
                      <button
                        class="edit-icon text-blue-500 ml-2"
                        onclick="openFormModal('edit', '<%= grandchild.id %>')"
                      >
                        ✏️
                      </button>
                      <button
                        class="delete-icon text-red-500 ml-2"
                        onclick="openDeleteModal('<%= grandchild.id %>')"
                      >
                        🗑️
                      </button>
                    </div>
                  </div>
                  <!-- Recursively display child nodes -->
                  <% if (grandchild.submenu && grandchild.submenu.length > 0) {
                  %>
                  <ul class="pl-4 border-l border-gray-300 hidden">
                    <% grandchild.submenu.forEach(greatGrandchild => { %>
                    <li
                      class="tree-node py-2 px-4 cursor-pointer relative rounded-md hover:bg-gray-200"
                    >
                      <div class="flex items-center relative">
                        <div
                          class="collapse-icon w-4 h-4 me-5 border border-gray-400 rounded-full flex items-center justify-center cursor-pointer"
                        >
                          ▶
                        </div>
                        <img
                          src="<%= greatGrandchild.icon %>"
                          class="h-7 w-7 me-2"
                          alt="<%= greatGrandchild.title %>"
                        />
                        <span><%= greatGrandchild.title %></span>
                        <div class="ml-auto flex items-center space-x-2">
                          <button
                            class="add-icon text-green-500 ml-2"
                            onclick="openFormModal('create', '<%= greatGrandchild.id %>')"
                          >
                            ➕
                          </button>
                          <button
                            class="edit-icon text-blue-500 ml-2"
                            onclick="openFormModal('edit', '<%= greatGrandchild.id %>')"
                          >
                            ✏️
                          </button>
                          <button
                            class="delete-icon text-red-500 ml-2"
                            onclick="openDeleteModal('<%= greatGrandchild.id %>')"
                          >
                            🗑️
                          </button>
                        </div>
                      </div>
                    </li>
                    <% }) %>
                  </ul>
                  <% } %>
                </li>
                <% }) %>
              </ul>
              <% } %>
            </li>
            <% }) %>
          </ul>
          <% } %>
        </li>
        <% }) %>
      </ul>
    </div>
  </div>
</div>

<script>
  // Open form modal for creating or editing routes
  async function openFormModal(type, parentId = null) {
    const modal =
      type === "create"
        ? document.querySelector(".route-form-modal")
        : document.querySelector(".route-form-modal-edit");
    const titleField =
      type === "create"
        ? document.querySelector("#title")
        : document.querySelector("#edit-title");
    const priorityField =
      type === "create"
        ? document.querySelector("#priority")
        : document.querySelector("#edit-priority");
    const linkField =
      type === "create"
        ? document.querySelector("#route-link")
        : document.querySelector("#edit-route-link");
    const tooltipField =
      type === "create"
        ? document.querySelector("#tooltip")
        : document.querySelector("#edit-tooltip");
    const fileField =
      type === "create"
        ? document.querySelector("#file")
        : document.querySelector("#edit-file");
    const saveButton = document.querySelector("#save-route");
    const updateButton = document.querySelector("#update-route");

    console.log({ type, parentId });

    if (type === "create") {
      titleField.value = "";
      priorityField.value = "medium";
      linkField.value = "";
      tooltipField.value = "";
      fileField.value = "";
      saveButton.onclick = () => submitForm(parentId);
    } else {
      const routeId = parentId;
      // Fetch route data and populate fields

      const response = await fetch(
        `${window.location.origin}/admin/menu/fm/${routeId}`
      );
      const result = await response.json();

      console.log(result.data);
      titleField.value = result.data.title;
      priorityField.value = result.data.priority;
      linkField.value = result.data.link;
      tooltipField.value = result.data.tooltip;
      fileField.value = "";
      document.getElementById("edit-id").value = result.data.id;
    }

    modal.classList.remove("hidden");
  }

  document.getElementById("update-route").addEventListener("click", async () => {
  const id = document.getElementById("edit-id").value;
  const titleField = document.querySelector("#edit-title").value;
  const priorityField = document.querySelector("#edit-priority").value;
  const linkField = document.querySelector("#edit-route-link").value;
  const tooltipField = document.querySelector("#edit-tooltip").value;
  const iconField = document.querySelector("#edit-file").files[0];

  // Create a FormData object to handle both text fields and file upload
  const formData = new FormData();
  formData.append("title", titleField);
  formData.append("priority", priorityField);
  formData.append("link", linkField);
  formData.append("tooltip", tooltipField);

  if (iconField) {
    formData.append("icon", iconField);
  }

  try {
    const response = await fetch(`${window.location.origin}/admin/menu/fm/${id}`, {
      method: "PUT",
      body: formData,
    });

    const result = await response.json();
    console.log(result);

    if (response.status === 200) {
      document.querySelector(".route-form-modal-edit").classList.add("hidden");
      window.location.href = window.location.href;
    } else {
      alert("Failed to update the route. Please try again.");
    }
  } catch (error) {
    console.error("Error during the request:", error);
    alert("An error occurred while updating the route.");
  }
});


  // Submit form for creating a new route
  async function submitForm(parentId) {
    console.log(parentId);
    const title = document.querySelector("#title").value;
    const priority = document.querySelector("#priority").value;
    const link = document.querySelector("#route-link").value;
    const tooltip = document.querySelector("#tooltip").value;
    const file = document.querySelector("#file").files[0];
    console.log(priority);

    const formData = new FormData();
    formData.append("title", title);
    formData.append("priority", priority);
    formData.append("link", link);
    formData.append("tooltip", tooltip);
    if (file) formData.append("icon", file);
    if (parentId) formData.append("parent_id", parentId);

    await fetch(
      `${window.location.origin}/admin/menu/fm?parent_id=${parentId}`,
      {
        method: "POST",
        body: formData,
      }
    )
      .then((response) => response.json())
      .then((data) => {
        console.log(data);
        location.reload(); // Refresh the page to show new route
      });
  }

  // Update route details
  function updateRoute(routeId) {
    const title = document.querySelector("#edit-title").value;
    const priority = document.querySelector("#edit-priority").value;
    const link = document.querySelector("#edit-route-link").value;
    const tooltip = document.querySelector("#edit-tooltip").value;
    const file = document.querySelector("#edit-file").files[0];

    const formData = new FormData();
    formData.append("title", title);
    formData.append("priority", priority);
    formData.append("link", link);
    formData.append("tooltip", tooltip);
    if (file) formData.append("icon", file);

    fetch(`${window.location.origin}/admin/menu/fm/${routeId}`, {
      method: "PUT",
      body: formData,
    })
      .then((response) => response.json())
      .then(() => {
        location.reload(); // Refresh the page to show updated route
      });
  }

  // Open delete modal
  function openDeleteModal(routeId) {
    const modal = document.querySelector(".delete-modal");
    modal.classList.remove("hidden");

    document.querySelector(".confirm-delete").onclick = async () => {
      await fetch(`${window.location.origin}/admin/menu/fm/${routeId}/delete`, {
        method: "GET",
      })
        .then((response) => response.json())
        .then((data) => {
          console.log(data);
          location.reload(); // Refresh the page to remove deleted route
        });
    };
  }

  // Close modals
  document
    .querySelectorAll(
      ".close-form-modal, .close-form-modal-edit, .close-delete-modal"
    )
    .forEach((button) => {
      button.addEventListener("click", () => {
        button.closest(".modal").classList.add("hidden");
      });
    });

  // Handle tree view collapsible nodes
  document.querySelectorAll(".collapse-icon").forEach((icon) => {
    icon.addEventListener("click", (event) => {
      const ul = event.target.closest("li").querySelector("ul");
      if (ul) {
        ul.classList.toggle("hidden");
        icon.textContent = ul.classList.contains("hidden") ? "▶" : "▼";
      }
    });
  });

  // Show create root route form
  document
    .querySelector("#show-create-root-form")
    .addEventListener("click", () => {
      openFormModal("create");
    });
</script>

<%- include('../wrapper/footer') %>
